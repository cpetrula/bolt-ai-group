// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum TenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  TRIAL
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

model Tenant {
  id              String        @id @default(uuid())
  name            String
  businessType    String        @default("salon")
  status          TenantStatus  @default(TRIAL)
  settings        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  users           User[]
  employees       Employee[]
  services        Service[]
  appointments    Appointment[]

  @@map("tenants")
}

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  password          String
  isEmailVerified   Boolean   @default(false)
  twoFactorEnabled  Boolean   @default(false)
  twoFactorSecret   String?
  resetToken        String?
  resetTokenExpiry  DateTime?
  tenantId          String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  tenant            Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("users")
}

model Employee {
  id                String              @id @default(uuid())
  tenantId          String
  name              String
  role              String?
  phone             String?
  email             String?
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  tenant            Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  schedules         EmployeeSchedule[]
  employeeServices  EmployeeService[]
  appointments      Appointment[]

  @@index([tenantId])
  @@map("employees")
}

model EmployeeSchedule {
  id          String    @id @default(uuid())
  tenantId    String
  employeeId  String
  dayOfWeek   Int       // 0-6, where 0 is Sunday
  startTime   String    // e.g., "09:00"
  endTime     String    // e.g., "17:00"
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([employeeId])
  @@map("employee_schedules")
}

model Service {
  id                String            @id @default(uuid())
  tenantId          String
  name              String
  description       String?           @db.Text
  basePrice         Decimal           @db.Decimal(10, 2)
  durationMinutes   Int
  isActive          Boolean           @default(true)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  addons            ServiceAddon[]
  employeeServices  EmployeeService[]
  appointments      Appointment[]

  @@index([tenantId])
  @@map("services")
}

model ServiceAddon {
  id              String    @id @default(uuid())
  tenantId        String
  serviceId       String
  name            String
  price           Decimal   @db.Decimal(10, 2)
  durationMinutes Int
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  service         Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([serviceId])
  @@map("service_addons")
}

model EmployeeService {
  id          String    @id @default(uuid())
  tenantId    String
  employeeId  String
  serviceId   String
  createdAt   DateTime  @default(now())
  
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  service     Service   @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([employeeId, serviceId])
  @@index([tenantId])
  @@index([employeeId])
  @@index([serviceId])
  @@map("employee_services")
}

model Appointment {
  id                  String              @id @default(uuid())
  tenantId            String
  employeeId          String
  serviceId           String
  customerName        String
  customerEmail       String?
  customerPhone       String?
  appointmentDate     DateTime
  startTime           String              // e.g., "09:00"
  endTime             String              // e.g., "10:30"
  status              AppointmentStatus   @default(SCHEDULED)
  totalPrice          Decimal             @db.Decimal(10, 2)
  totalDuration       Int                 // Total duration in minutes
  notes               String?             @db.Text
  cancellationReason  String?             @db.Text
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  
  tenant              Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employee            Employee            @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  service             Service             @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  addons              AppointmentAddon[]

  @@index([tenantId])
  @@index([employeeId])
  @@index([serviceId])
  @@index([appointmentDate])
  @@index([status])
  @@map("appointments")
}

model AppointmentAddon {
  id              String        @id @default(uuid())
  tenantId        String
  appointmentId   String
  addonId         String
  name            String
  price           Decimal       @db.Decimal(10, 2)
  durationMinutes Int
  createdAt       DateTime      @default(now())
  
  appointment     Appointment   @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([appointmentId])
  @@map("appointment_addons")
}
