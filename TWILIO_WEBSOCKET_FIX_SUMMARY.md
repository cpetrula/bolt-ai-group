# Twilio WebSocket Connection Fix - Summary

## Problem
Incoming calls to Twilio were failing with a WebSocket handshake error when attempting to connect to Vapi AI assistant:

```
Error: Stream - WebSocket - Handshake Error
Description: The server has returned an HTTP code different from 101 to the connection request
```

The calls were not even reaching Vapi according to Vapi logs.

## Root Cause
The WebSocket connection to Vapi was using a static WebSocket URL, which is an outdated approach:

**Previous Attempts:**
```
wss://api.vapi.ai/call/twilio  (did not exist)
wss://api.vapi.ai/v1/twiliows?Vapi-Key=${vapiApiKey}&assistantId=${assistantId}  (wrong parameter name)
wss://api.vapi.ai/v2/stream?assistantId=${assistantId}&apikey=${vapiApiKey}  (static URL - incorrect approach)
```

These attempts all failed because Vapi requires a **call-specific WebSocket URL** that is dynamically generated for each call.

## Solution
Implemented Vapi's **Phone Call Provider Bypass** approach:

**Correct Flow:**
1. When Twilio receives an inbound call, it sends a webhook to our backend
2. Backend calls Vapi's API: `POST https://api.vapi.ai/call` with `phoneCallProviderBypassEnabled: true`
3. Vapi creates a call and returns TwiML containing a call-specific WebSocket URL (e.g., `wss://api.vapi.ai/{call-id}/transport`)
4. Backend returns this TwiML to Twilio
5. Twilio connects to the call-specific WebSocket URL provided by Vapi

### Key Changes

1. **Implemented Phone Call Provider Bypass**: 
   - Changed from static WebSocket URL generation to calling Vapi's API
   - Uses `POST https://api.vapi.ai/call` with `phoneCallProviderBypassEnabled: true`

2. **Dynamic WebSocket URL**: 
   - Vapi now generates a unique WebSocket URL for each call
   - URL format: `wss://api.vapi.ai/{unique-call-id}/transport`

3. **Enhanced VapiService**:
   - Added `createInboundCall()` method to handle incoming calls
   - Passes business name, tenant ID, and metadata to Vapi
   - Returns TwiML from Vapi's API response

4. **Updated Call Handler**:
   - Removed static TwiML generation with hardcoded WebSocket URL
   - Now calls `vapiService.createInboundCall()` to get dynamic TwiML
   - Added error handling with fallback to basic greeting

5. **Environment Configuration**:
   - Added optional `VAPI_PHONE_NUMBER_ID` for Vapi phone number configuration

## Technical Details

### Vapi Phone Call Provider Bypass
Based on Vapi's official documentation and examples:
- API Endpoint: `https://api.vapi.ai/call`
- Required payload:
  ```javascript
  {
    assistantId: 'your-assistant-id',
    phoneCallProviderBypassEnabled: true,
    customer: { number: '+1234567890' },
    phoneNumberId: 'optional-phone-number-id',  // Optional
    metadata: { /* custom data */ },             // Optional
    assistantOverrides: {
      variableValues: {
        businessName: 'Your Business Name'       // Optional
      }
    }
  }
  ```
- API returns a response containing:
  ```javascript
  {
    id: 'call-id',
    phoneCallProviderDetails: {
      twiml: '<?xml version="1.0"?>...'  // TwiML with call-specific WebSocket URL
    }
  }
  ```

### TwiML Generated by Vapi
Vapi generates TwiML with a unique WebSocket URL for each call:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<Response>
  <Connect>
    <Stream url="wss://api.vapi.ai/{unique-call-id}/transport">
      <!-- Vapi manages parameters internally -->
    </Stream>
  </Connect>
</Response>
```

### Security Considerations
- API key is passed in the Authorization header to Vapi's API (secure)
- WebSocket URL is generated by Vapi and contains a unique call ID
- No API keys are exposed in WebSocket URLs or TwiML
- All communication uses HTTPS and WSS protocols

## Files Modified
1. `backend/src/modules/telephony/call.handler.js`
   - Removed `validateVapiConfiguration()` helper function (no longer needed)
   - Removed `generateVapiConnectTwiML()` function (replaced with API call)
   - Updated `handleIncomingCall()` to call `vapiService.createInboundCall()`
   - Added error handling with fallback to basic greeting

2. `backend/src/modules/ai-assistant/vapi.service.js`
   - Added `phoneNumberId` property to VapiService class
   - Implemented `createInboundCall()` method for phone call provider bypass
   - Method calls Vapi's API and returns TwiML response

3. `backend/src/config/env.js`
   - Added `vapiPhoneNumberId` environment variable (optional)

4. `TWILIO_WEBSOCKET_FIX_SUMMARY.md`
   - Updated to reflect the new implementation approach

## Testing
- ✅ Syntax validation passed
- ✅ Code implements Vapi's official phone call provider bypass approach
- ⏳ Integration testing required (needs Vapi API credentials and Twilio phone number)

## Verification
To verify the fix is working:

1. Ensure environment variables are set:
   ```
   VAPI_API_KEY=YOUR_VAPI_API_KEY_HERE
   VAPI_ASSISTANT_ID=YOUR_ASSISTANT_ID_HERE
   VAPI_PHONE_NUMBER_ID=YOUR_PHONE_NUMBER_ID_HERE  # Optional
   ```

2. Make a test call to your Twilio number

3. Check logs for:
   ```
   Creating Vapi inbound call for tenant: [tenant-name]
   Successfully created Vapi inbound call
   ```

4. The call should connect successfully without WebSocket handshake errors

5. Check Vapi dashboard to confirm call was received

## References
- [Vapi Call Handling with Twilio Documentation](https://docs.vapi.ai/calls/call-handling-with-vapi-and-twilio)
- [Vapi WebSocket Transport Documentation](https://docs.vapi.ai/calls/websocket-transport)
- [Vapi Phone Call Provider Bypass Example (GitHub)](https://github.com/VapiAI/example-phone-call-provider-bypass)
- [Twilio Stream TwiML Reference](https://www.twilio.com/docs/voice/twiml/stream)
- [Twilio Media Streams WebSocket Messages](https://www.twilio.com/docs/voice/media-streams/websocket-messages)

## Future Considerations
- Monitor WebSocket connection stability
- Implement retry logic for failed Vapi API calls
- Consider implementing call recording and analytics
- Keep Vapi SDK/integration updated as their API evolves
- Validate that all incoming calls are properly logged in Vapi dashboard
